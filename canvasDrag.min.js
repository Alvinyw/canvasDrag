!function(e){e.fn.canvasDrag=function(t){function i(){var e=k[0].getContext("2d");e.clearRect(0,0,k.width(),k.height()),r(),e.beginPath(),e.strokeStyle=b?h.errorLineColor:h.defaultLineColor,e.lineWidth=l,e.moveTo(y[0],y[1]),e.lineTo(y[2],y[3]),e.lineTo(y[4],y[5]),e.lineTo(y[6],y[7]),e.closePath(),e.stroke(),n(y[0],y[1],d,f),n(y[2],y[3],d,f),n(y[4],y[5],d,f),n(y[6],y[7],d,f),n(R[0],R[1],u,c),n(R[2],R[3],u,c),n(R[4],R[5],u,c),n(R[6],R[7],u,c)}function n(e,t,i,n){var r=k[0].getContext("2d");r.beginPath(),r.strokeStyle=b?h.errorRadiusColor:h.defaultRadiusColor,r.lineWidth=2*(i-n),r.arc(e,t,i,0,2*Math.PI),r.stroke(),r.closePath(),r.beginPath(),r.fillStyle=h.innerRadiusFillColor,r.arc(e,t,n,0,2*Math.PI),r.fill(),r.closePath()}function r(){return R[0]=(y[0]+y[2])/2,R[1]=(y[1]+y[3])/2,R[2]=(y[2]+y[4])/2,R[3]=(y[3]+y[5])/2,R[4]=(y[4]+y[6])/2,R[5]=(y[5]+y[7])/2,R[6]=(y[6]+y[0])/2,R[7]=(y[7]+y[1])/2,R}function o(){for(var e=0;e<4;e++)e<3?y[2*e+3]-y[2*e+1]==0&&y[2*(e+1)]-y[2*e]==0?P[e]=0:P[e]=(y[2*e+3]-y[2*e+1])/(y[2*(e+1)]-y[2*e]):3==e&&(y[7]-y[1]==0&&y[6]-y[0]==0?P[3]=0:P[3]=(y[7]-y[1])/(y[6]-y[0]));return P}function a(){for(var e=0;e<y.length/2;e++)y[2*e]<0?y[2*e]=0:y[2*e]>k.width()-1&&(y[2*e]=k.width()-1),y[2*e+1]<0?y[2*e+1]=0:y[2*e+1]>k.height()-1&&(y[2*e+1]=k.height()-1)}function s(){var e=y,t=e[0],i=e[1],n=e[2],r=e[3],o=e[4],a=e[5],s=e[6],h=e[7],l=a-i,d=t-o,f=o*i-t*a,u=h-r,c=n-s,v=s*r-n*h;return l*n+d*r+f>0&&l*s+d*h+f<0&&u*t+c*i+v<0&&u*o+c*a+v>0?(x=!1,!1):(x=!0,!0)}var h=e.extend({operationPanel:"#operationPanel",canvasWrapperClass:"canvasDragWrapper",dragBgContentClass:"dragBgContent",canvasEditerClass:"canvasEditer",defaultPointInfo:0,dragBgSrc:"",canvasWrapperBorder:"1px solid #ddd",brushThickness:3,defaultLineColor:"#50a8e1",errorLineColor:"red",defaultRadiusColor:"#50a8e1",errorRadiusColor:"red",innerRadiusFillColor:"rgba(255,255,255,.5)",vertexOuterRadius:6,vertexInnerRadius:5,midpointOuterRadius:5,midpointInnerRadius:4,mouseX:"#mouseX",mouseY:"#mouseY"},t),l=h.brushThickness,d=h.vertexOuterRadius<l+4?l+4:h.vertexOuterRadius,f=h.vertexInnerRadius>d-1?d-1:h.vertexInnerRadius<l+3?l+3:h.vertexInnerRadius,u=h.midpointOuterRadius>f?f:h.midpointOuterRadius<l+3?l+3:h.midpointOuterRadius,c=h.midpointInnerRadius>u-1?u-1:h.midpointInnerRadius<l+2?l+2:h.midpointInnerRadius;e(h.operationPanel).html('<div class="'+h.canvasWrapperClass+'" oncontextmenu="return false;"><div class="'+h.dragBgContentClass+'"></div><canvas class="'+h.canvasEditerClass+'"></canvas></div>');var v,g,p,m,w,I,y=new Array(8),R=new Array(8),C=new Array(8),P=new Array(4),b=!1,x=!1,B="",M=e(h.operationPanel+" ."+h.canvasWrapperClass),W=e(h.operationPanel+" ."+h.dragBgContentClass),k=e(h.operationPanel+" ."+h.canvasEditerClass),O=e(h.operationPanel).width(),S=e(h.operationPanel).height(),T=O/S;if(M.css({position:"relative",width:O,height:S,border:h.canvasWrapperBorder}),W.css({position:"relative",width:O,height:S}),k.css({position:"absolute",top:0,left:0,"user-select":"none","-webkit-user-select":"none","-moz-user-select":"none","-ms-user-select":"none"}),k.attr("width",O).attr("height",S),""!=h.dragBgSrc){var X=new Image;X.src=h.dragBgSrc,X.onload=function(){var t=X.width/X.height;if(e(X).css("position","absolute"),t>T?(X.width=O,X.height=O/t,e(X).css({top:(S-X.height)/2,left:0})):(X.height=S,X.width=X.height*t,e(X).css({top:0,left:(O-X.width)/2})),k.attr("width",X.width).attr("height",X.height),k.css({top:(S-X.height)/2,left:(O-X.width)/2}),8==h.defaultPointInfo.length)for(var n=0;n<h.defaultPointInfo.length;n++)y[n]=h.defaultPointInfo[n];else y[0]=0,y[1]=0,y[2]=X.width,y[3]=0,y[4]=X.width,y[5]=X.height,y[6]=0,y[7]=X.height;i()},W.append(X)}else if(8==h.defaultPointInfo.length)for(var Y=0;Y<h.defaultPointInfo.length;Y++)y[Y]=h.defaultPointInfo[Y];else y[0]=0,y[1]=0,y[2]=k.width(),y[3]=0,y[4]=k.width(),y[5]=k.height(),y[6]=0,y[7]=k.height();i(),k.on("mousedown",function(t){for(var n=k[0].getContext("2d"),r=(t||window.event).offsetX,l=(t||window.event).offsetY,M=0;M<C.length;M++)C[M]=M<4?Math.abs(y[2*M]-r)<2*d-f&&Math.abs(y[2*M+1]-l)<2*d-f:Math.abs(R[2*(M-4)]-r)<2*u-c&&Math.abs(R[2*(M-4)+1]-l)<2*u-c;for(M=C.length-1;M>-1;M--)if(M<4&&1==C[M])for(var W=0;W<C.length;W++)M!=W&&(C[W]=!1);for(M=0;M<C.length;M++)1!=C[M]||x||(B=M,M<4?(v=y[2*M],g=y[2*M+1]):(p=y[2*(M-4)],m=y[2*(M-4)+1],w=y[(2*(M-4)+2)%8],I=y[(2*(M-4)+3)%8]));e(this).mousemove(function(t){var r=(t||window.event).offsetX,l=(t||window.event).offsetY;e(h.mouseX).html(r),e(h.mouseY).html(l);for(var d=0;d<C.length;d++)if(d<4&&1==C[d])e(this).css("cursor","move"),n.clearRect(0,0,k.width(),k.height()),y[2*d]=r,y[2*d+1]=l,o(),a(),b=!!s(),i();else if(4==d&&1==C[4]){e(this).css("cursor","move"),n.clearRect(0,0,k.width(),k.height());var f=y[0],u=y[1],c=y[2],v=y[3],g=P[0],p=-1,m=l-P[0]*r,w=P[1],I=-1,x=y[3]-P[1]*y[2],B=P[3],M=-1,W=y[1]-P[3]*y[0];0==P[0]?("Infinity"==P[1]?(y[2]=y[2],y[3]=l):(y[2]=(l-y[3])/P[1]+y[2],y[3]=l),"Infinity"==P[3]?(y[0]=y[0],y[1]=l):(y[0]=(l-y[1])/P[3]+y[0],y[1]=l)):"Infinity"==P[0]?(0==P[1]?(y[2]=r,y[3]=y[3]):(y[3]=P[1]*(r-y[2])+y[3],y[2]=r),0==P[3]?(y[0]=r,y[1]=y[1]):(y[1]=P[3]*(r-y[0])+y[1],y[0]=r)):(0==P[1]?(y[2]=y[2]+(r-R[0]),y[3]=y[3]):"Infinity"==P[1]?(y[2]=y[2],y[3]=y[3]+(l-R[1])):(y[2]=(I*m-p*x)/(w*p-g*I),y[3]=(g*x-w*m)/(w*p-g*I)),0==P[3]?(y[0]=y[0]+(r-R[0]),y[1]=y[1]):"Infinity"==P[3]?(y[0]=y[0],y[1]=y[1]+(l-R[1])):(y[0]=(M*m-p*W)/(B*p-g*M),y[1]=(g*W-B*m)/(B*p-g*M))),a(),s()?(b=!0,y[0]=f,y[1]=u,y[2]=c,y[3]=v):b=!1,i()}else if(5==d&&1==C[5]){e(this).css("cursor","move"),n.clearRect(0,0,k.width(),k.height());var f=y[2],u=y[3],c=y[4],v=y[5],g=P[1],p=-1,m=l-P[1]*r,w=P[0],I=-1,x=y[3]-P[0]*y[2],B=P[2],M=-1,W=y[5]-P[2]*y[4];0==P[1]?("Infinity"==P[2]?(y[4]=y[4],y[5]=l):(y[4]=(l-y[5])/P[2]+y[4],y[5]=l),"Infinity"==P[0]?(y[2]=y[2],y[3]=l):(y[2]=(l-y[3])/P[0]+y[2],y[3]=l)):"Infinity"==P[1]?(0==P[2]?(y[4]=r,y[5]=y[5]):(y[5]=P[2]*(r-y[4])+y[5],y[4]=r),0==P[0]?(y[2]=r,y[3]=y[3]):(y[3]=P[0]*(r-y[2])+y[3],y[2]=r)):(0==P[2]?(y[4]=y[4]+(r-R[2]),y[5]=y[5]):"Infinity"==P[2]?(y[4]=y[4],y[5]=y[5]+(l-R[3])):(y[4]=(M*m-p*W)/(B*p-g*M),y[5]=(g*W-B*m)/(B*p-g*M)),0==P[0]?(y[2]=y[2]+(r-R[2]),y[3]=y[3]):"Infinity"==P[0]?(y[2]=y[2],y[3]=y[3]+(l-R[3])):(y[2]=(I*m-p*x)/(w*p-g*I),y[3]=(g*x-w*m)/(w*p-g*I))),a(),s()?(b=!0,y[2]=f,y[3]=u,y[4]=c,y[5]=v):b=!1,i()}else if(6==d&&1==C[6]){e(this).css("cursor","move"),n.clearRect(0,0,k.width(),k.height());var f=y[4],u=y[5],c=y[6],v=y[7],g=P[2],p=-1,m=l-P[2]*r,w=P[1],I=-1,x=y[5]-P[1]*y[4],B=P[3],M=-1,W=y[7]-P[3]*y[6];0==P[2]?("Infinity"==P[3]?(y[6]=y[6],y[7]=l):(y[6]=(l-y[7])/P[3]+y[6],y[7]=l),"Infinity"==P[1]?(y[4]=y[4],y[5]=l):(y[4]=(l-y[5])/P[1]+y[4],y[5]=l)):"Infinity"==P[2]?(0==P[3]?(y[6]=r,y[7]=y[7]):(y[7]=P[3]*(r-y[6])+y[7],y[6]=r),0==P[1]?(y[4]=r,y[5]=y[5]):(y[5]=P[1]*(r-y[4])+y[5],y[4]=r)):(0==P[3]?(y[6]=y[6]+(r-R[4]),y[7]=y[7]):"Infinity"==P[3]?(y[6]=y[6],y[7]=y[7]+(l-R[5])):(y[6]=(M*m-p*W)/(B*p-g*M),y[7]=(g*W-B*m)/(B*p-g*M)),0==P[1]?(y[4]=y[4]+(r-R[4]),y[5]=y[5]):"Infinity"==P[1]?(y[4]=y[4],y[5]=y[5]+(l-R[5])):(y[4]=(I*m-p*x)/(w*p-g*I),y[5]=(g*x-w*m)/(w*p-g*I))),a(),s()?(b=!0,y[4]=f,y[5]=u,y[6]=c,y[7]=v):b=!1,i()}else if(7==d&&1==C[7]){e(this).css("cursor","move"),n.clearRect(0,0,k.width(),k.height());var f=y[6],u=y[7],c=y[0],v=y[1],g=P[3],p=-1,m=l-P[3]*r,w=P[2],I=-1,x=y[7]-P[2]*y[6],B=P[0],M=-1,W=y[1]-P[0]*y[0];0==P[3]?("Infinity"==P[0]?(y[0]=y[0],y[1]=l):(y[0]=(l-y[1])/P[0]+y[0],y[1]=l),"Infinity"==P[2]?(y[6]=y[6],y[7]=l):(y[6]=(l-y[7])/P[2]+y[6],y[7]=l)):"Infinity"==P[3]?(0==P[0]?(y[0]=r,y[1]=y[1]):(y[1]=P[0]*(r-y[0])+y[1],y[0]=r),0==P[2]?(y[6]=r,y[7]=y[7]):(y[7]=P[2]*(r-y[6])+y[7],y[6]=r)):(0==P[0]?(y[0]=y[0]+(r-R[6]),y[1]=y[1]):"Infinity"==P[0]?(y[0]=y[0],y[1]=y[1]+(l-R[7])):(y[0]=(M*m-p*W)/(B*p-g*M),y[1]=(g*W-B*m)/(B*p-g*M)),0==P[2]?(y[6]=y[6]+(r-R[6]),y[7]=y[7]):"Infinity"==P[2]?(y[6]=y[6],y[7]=y[7]+(l-R[7])):(y[6]=(I*m-p*x)/(w*p-g*I),y[7]=(g*x-w*m)/(w*p-g*I))),a(),s()?(b=!0,y[6]=f,y[7]=u,y[0]=c,y[1]=v):b=!1,i()}})}),k.on("mouseup",function(t){if(e(this).css("cursor","default"),e(this).off("mousemove"),B<4)x&&(y[2*B]=v,y[2*B+1]=g,o(),b=!1,i(),x=!1);else if(B>=4&&x){var n=B;y[2*(n-4)]=p,y[2*(n-4)+1]=m,y[(2*(n-4)+2)%8]=w,y[(2*(n-4)+3)%8]=I,o(),b=!1,i(),x=!1}for(var r=y,a=r[0],s=r[1],h=r[2],l=r[3],d=r[4],f=r[5],u=r[6],c=r[7];a>=h||l>=f||d<=u||c<=s||Math.abs((l+f-s-c)/(h+d-u-a))>Math.abs((f+c-s-l)/(d+u-a-h));){var R=a;a=h,h=d,d=u,u=R;var C=s;s=l,l=f,f=c,c=C}r[0]=a,r[1]=s,r[2]=h,r[3]=l,r[4]=d,r[5]=f,r[6]=u,r[7]=c}),k.on("mouseout",function(t){e(this).css("cursor","default"),e(this).off("mousemove")}),k.on("mouseover",function(t){e(this).css("cursor","default"),e(this).off("mousemove")})}}(jQuery);