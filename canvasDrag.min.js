/*! canvasDrag v1.0.0 | 2018-04-19 By Alvin | http://alvinwp.com/ */
!function(e){e.fn.canvasDrag=function(t){function i(){var e=k[0].getContext("2d");e.clearRect(0,0,k.width(),k.height()),r(),e.beginPath(),e.strokeStyle=b?h.errorLineColor:h.defaultLineColor,e.lineWidth=d,e.moveTo(v[0],v[1]),e.lineTo(v[2],v[3]),e.lineTo(v[4],v[5]),e.lineTo(v[6],v[7]),e.closePath(),e.stroke(),n(v[0],v[1],l,u),n(v[2],v[3],l,u),n(v[4],v[5],l,u),n(v[6],v[7],l,u),n(R[0],R[1],f,c),n(R[2],R[3],f,c),n(R[4],R[5],f,c),n(R[6],R[7],f,c)}function n(e,t,i,n){var r=k[0].getContext("2d");r.beginPath(),r.strokeStyle=b?h.errorRadiusColor:h.defaultRadiusColor,r.lineWidth=2*(i-n),r.arc(e,t,i,0,2*Math.PI),r.stroke(),r.closePath(),r.beginPath(),r.fillStyle=h.innerRadiusFillColor,r.arc(e,t,n,0,2*Math.PI),r.fill(),r.closePath()}function r(){return R[0]=(v[0]+v[2])/2,R[1]=(v[1]+v[3])/2,R[2]=(v[2]+v[4])/2,R[3]=(v[3]+v[5])/2,R[4]=(v[4]+v[6])/2,R[5]=(v[5]+v[7])/2,R[6]=(v[6]+v[0])/2,R[7]=(v[7]+v[1])/2,R}function o(){for(var e=0;e<4;e++)e<3?v[2*e+3]-v[2*e+1]==0&&v[2*(e+1)]-v[2*e]==0?P[e]=0:P[e]=(v[2*e+3]-v[2*e+1])/(v[2*(e+1)]-v[2*e]):3==e&&(v[7]-v[1]==0&&v[6]-v[0]==0?P[3]=0:P[3]=(v[7]-v[1])/(v[6]-v[0]));return P}function s(){for(var e=0;e<v.length/2;e++)v[2*e]<0?v[2*e]=0:v[2*e]>k.width()-1&&(v[2*e]=k.width()-1),v[2*e+1]<0?v[2*e+1]=0:v[2*e+1]>k.height()-1&&(v[2*e+1]=k.height()-1)}function a(){var e=v,t=e[0],i=e[1],n=e[2],r=e[3],o=e[4],s=e[5],a=e[6],h=e[7],d=s-i,l=t-o,u=o*i-t*s,f=h-r,c=n-a,g=a*r-n*h;return d*n+l*r+u>0&&d*a+l*h+u<0&&f*t+c*i+g<0&&f*o+c*s+g>0?(x=!1,!1):(x=!0,!0)}var h=e.extend({operationPanel:"#operationPanel",canvasWrapperClass:"canvasDragWrapper",dragBgContentClass:"dragBgContent",canvasEditerClass:"canvasEditer",defaultPointInfo:0,dragBgSrc:"",canvasWrapperBorder:"1px solid #ddd",brushThickness:3,defaultLineColor:"#50a8e1",errorLineColor:"red",defaultRadiusColor:"#50a8e1",errorRadiusColor:"red",innerRadiusFillColor:"rgba(255,255,255,.5)",vertexOuterRadius:6,vertexInnerRadius:5,midpointOuterRadius:5,midpointInnerRadius:4,mouseX:"#mouseX",mouseY:"#mouseY"},t),d=h.brushThickness,l=h.vertexOuterRadius<d+4?d+4:h.vertexOuterRadius,u=h.vertexInnerRadius>l-1?l-1:h.vertexInnerRadius<d+3?d+3:h.vertexInnerRadius,f=h.midpointOuterRadius>u?u:h.midpointOuterRadius<d+3?d+3:h.midpointOuterRadius,c=h.midpointInnerRadius>f-1?f-1:h.midpointInnerRadius<d+2?d+2:h.midpointInnerRadius;e(h.operationPanel).html('<div class="'+h.canvasWrapperClass+'" oncontextmenu="return false;"><div class="'+h.dragBgContentClass+'"></div><canvas class="'+h.canvasEditerClass+'"></canvas></div>');var v=new Array(8);v=""==h.defaultPointInfo?[]:h.defaultPointInfo;var g,m,p,w,I,y,R=new Array(8),C=new Array(8),P=new Array(4),b=!1,x=!1,B="",M=e(h.operationPanel+" ."+h.canvasWrapperClass),W=e(h.operationPanel+" ."+h.dragBgContentClass),k=e(h.operationPanel+" ."+h.canvasEditerClass),O=e(h.operationPanel).width(),T=e(h.operationPanel).height(),S=O/T,X=new Image;X.src=h.dragBgSrc,X.onload=function(){var t=X.width/X.height;e(X).css("position","absolute"),t>S?(X.width=O,X.height=O/t,e(X).css({top:(T-X.height)/2,left:0})):(X.height=T,X.width=X.height*t,e(X).css({top:0,left:(O-X.width)/2})),null==v[0]&&(v[0]=0,v[1]=0,v[2]=X.width,v[3]=0,v[4]=X.width,v[5]=X.height,v[6]=0,v[7]=X.height),k.attr("width",X.width).attr("height",X.height),k.css({top:(T-X.height)/2,left:(O-X.width)/2}),i()},W.append(X),M.css({position:"relative",width:O,height:T,border:h.canvasWrapperBorder}),W.css({position:"relative",width:O,height:T}),k.css({position:"absolute","user-select":"none","-webkit-user-select":"none","-moz-user-select":"none","-ms-user-select":"none"}),k.on("mousedown",function(t){for(var n=k[0].getContext("2d"),r=(t||window.event).offsetX,d=(t||window.event).offsetY,M=0;M<C.length;M++)C[M]=M<4?Math.abs(v[2*M]-r)<2*l-u&&Math.abs(v[2*M+1]-d)<2*l-u:Math.abs(R[2*(M-4)]-r)<2*f-c&&Math.abs(R[2*(M-4)+1]-d)<2*f-c;for(M=C.length-1;M>-1;M--)if(M<4&&1==C[M])for(var W=0;W<C.length;W++)M!=W&&(C[W]=!1);for(M=0;M<C.length;M++)1!=C[M]||x||(B=M,M<4?(g=v[2*M],m=v[2*M+1]):(p=v[2*(M-4)],w=v[2*(M-4)+1],I=v[(2*(M-4)+2)%8],y=v[(2*(M-4)+3)%8]));e(this).mousemove(function(t){var r=(t||window.event).offsetX,d=(t||window.event).offsetY;e(h.mouseX).html(r),e(h.mouseY).html(d);for(var l=0;l<C.length;l++)if(l<4&&1==C[l])e(this).css("cursor","move"),n.clearRect(0,0,k.width(),k.height()),v[2*l]=r,v[2*l+1]=d,o(),s(),b=!!a(),i();else if(4==l&&1==C[4]){e(this).css("cursor","move"),n.clearRect(0,0,k.width(),k.height());var u=v[0],f=v[1],c=v[2],g=v[3],m=P[0],p=-1,w=d-P[0]*r,I=P[1],y=-1,x=v[3]-P[1]*v[2],B=P[3],M=-1,W=v[1]-P[3]*v[0];0==P[0]?("Infinity"==P[1]?(v[2]=v[2],v[3]=d):(v[2]=(d-v[3])/P[1]+v[2],v[3]=d),"Infinity"==P[3]?(v[0]=v[0],v[1]=d):(v[0]=(d-v[1])/P[3]+v[0],v[1]=d)):"Infinity"==P[0]?(0==P[1]?(v[2]=r,v[3]=v[3]):(v[3]=P[1]*(r-v[2])+v[3],v[2]=r),0==P[3]?(v[0]=r,v[1]=v[1]):(v[1]=P[3]*(r-v[0])+v[1],v[0]=r)):(0==P[1]?(v[2]=v[2]+(r-R[0]),v[3]=v[3]):"Infinity"==P[1]?(v[2]=v[2],v[3]=v[3]+(d-R[1])):(v[2]=(y*w-p*x)/(I*p-m*y),v[3]=(m*x-I*w)/(I*p-m*y)),0==P[3]?(v[0]=v[0]+(r-R[0]),v[1]=v[1]):"Infinity"==P[3]?(v[0]=v[0],v[1]=v[1]+(d-R[1])):(v[0]=(M*w-p*W)/(B*p-m*M),v[1]=(m*W-B*w)/(B*p-m*M))),s(),a()?(b=!0,v[0]=u,v[1]=f,v[2]=c,v[3]=g):b=!1,i()}else if(5==l&&1==C[5]){e(this).css("cursor","move"),n.clearRect(0,0,k.width(),k.height());var u=v[2],f=v[3],c=v[4],g=v[5],m=P[1],p=-1,w=d-P[1]*r,I=P[0],y=-1,x=v[3]-P[0]*v[2],B=P[2],M=-1,W=v[5]-P[2]*v[4];0==P[1]?("Infinity"==P[2]?(v[4]=v[4],v[5]=d):(v[4]=(d-v[5])/P[2]+v[4],v[5]=d),"Infinity"==P[0]?(v[2]=v[2],v[3]=d):(v[2]=(d-v[3])/P[0]+v[2],v[3]=d)):"Infinity"==P[1]?(0==P[2]?(v[4]=r,v[5]=v[5]):(v[5]=P[2]*(r-v[4])+v[5],v[4]=r),0==P[0]?(v[2]=r,v[3]=v[3]):(v[3]=P[0]*(r-v[2])+v[3],v[2]=r)):(0==P[2]?(v[4]=v[4]+(r-R[2]),v[5]=v[5]):"Infinity"==P[2]?(v[4]=v[4],v[5]=v[5]+(d-R[3])):(v[4]=(M*w-p*W)/(B*p-m*M),v[5]=(m*W-B*w)/(B*p-m*M)),0==P[0]?(v[2]=v[2]+(r-R[2]),v[3]=v[3]):"Infinity"==P[0]?(v[2]=v[2],v[3]=v[3]+(d-R[3])):(v[2]=(y*w-p*x)/(I*p-m*y),v[3]=(m*x-I*w)/(I*p-m*y))),s(),a()?(b=!0,v[2]=u,v[3]=f,v[4]=c,v[5]=g):b=!1,i()}else if(6==l&&1==C[6]){e(this).css("cursor","move"),n.clearRect(0,0,k.width(),k.height());var u=v[4],f=v[5],c=v[6],g=v[7],m=P[2],p=-1,w=d-P[2]*r,I=P[1],y=-1,x=v[5]-P[1]*v[4],B=P[3],M=-1,W=v[7]-P[3]*v[6];0==P[2]?("Infinity"==P[3]?(v[6]=v[6],v[7]=d):(v[6]=(d-v[7])/P[3]+v[6],v[7]=d),"Infinity"==P[1]?(v[4]=v[4],v[5]=d):(v[4]=(d-v[5])/P[1]+v[4],v[5]=d)):"Infinity"==P[2]?(0==P[3]?(v[6]=r,v[7]=v[7]):(v[7]=P[3]*(r-v[6])+v[7],v[6]=r),0==P[1]?(v[4]=r,v[5]=v[5]):(v[5]=P[1]*(r-v[4])+v[5],v[4]=r)):(0==P[3]?(v[6]=v[6]+(r-R[4]),v[7]=v[7]):"Infinity"==P[3]?(v[6]=v[6],v[7]=v[7]+(d-R[5])):(v[6]=(M*w-p*W)/(B*p-m*M),v[7]=(m*W-B*w)/(B*p-m*M)),0==P[1]?(v[4]=v[4]+(r-R[4]),v[5]=v[5]):"Infinity"==P[1]?(v[4]=v[4],v[5]=v[5]+(d-R[5])):(v[4]=(y*w-p*x)/(I*p-m*y),v[5]=(m*x-I*w)/(I*p-m*y))),s(),a()?(b=!0,v[4]=u,v[5]=f,v[6]=c,v[7]=g):b=!1,i()}else if(7==l&&1==C[7]){e(this).css("cursor","move"),n.clearRect(0,0,k.width(),k.height());var u=v[6],f=v[7],c=v[0],g=v[1],m=P[3],p=-1,w=d-P[3]*r,I=P[2],y=-1,x=v[7]-P[2]*v[6],B=P[0],M=-1,W=v[1]-P[0]*v[0];0==P[3]?("Infinity"==P[0]?(v[0]=v[0],v[1]=d):(v[0]=(d-v[1])/P[0]+v[0],v[1]=d),"Infinity"==P[2]?(v[6]=v[6],v[7]=d):(v[6]=(d-v[7])/P[2]+v[6],v[7]=d)):"Infinity"==P[3]?(0==P[0]?(v[0]=r,v[1]=v[1]):(v[1]=P[0]*(r-v[0])+v[1],v[0]=r),0==P[2]?(v[6]=r,v[7]=v[7]):(v[7]=P[2]*(r-v[6])+v[7],v[6]=r)):(0==P[0]?(v[0]=v[0]+(r-R[6]),v[1]=v[1]):"Infinity"==P[0]?(v[0]=v[0],v[1]=v[1]+(d-R[7])):(v[0]=(M*w-p*W)/(B*p-m*M),v[1]=(m*W-B*w)/(B*p-m*M)),0==P[2]?(v[6]=v[6]+(r-R[6]),v[7]=v[7]):"Infinity"==P[2]?(v[6]=v[6],v[7]=v[7]+(d-R[7])):(v[6]=(y*w-p*x)/(I*p-m*y),v[7]=(m*x-I*w)/(I*p-m*y))),s(),a()?(b=!0,v[6]=u,v[7]=f,v[0]=c,v[1]=g):b=!1,i()}})}),k.on("mouseup",function(t){if(e(this).css("cursor","default"),e(this).off("mousemove"),B<4)x&&(v[2*B]=g,v[2*B+1]=m,o(),b=!1,i(),x=!1);else if(B>=4&&x){var n=B;v[2*(n-4)]=p,v[2*(n-4)+1]=w,v[(2*(n-4)+2)%8]=I,v[(2*(n-4)+3)%8]=y,o(),b=!1,i(),x=!1}for(var r=v,s=r[0],a=r[1],h=r[2],d=r[3],l=r[4],u=r[5],f=r[6],c=r[7];s>=h||d>=u||l<=f||c<=a||Math.abs((d+u-a-c)/(h+l-f-s))>Math.abs((u+c-a-d)/(l+f-s-h));){var R=s;s=h,h=l,l=f,f=R;var C=a;a=d,d=u,u=c,c=C}r[0]=s,r[1]=a,r[2]=h,r[3]=d,r[4]=l,r[5]=u,r[6]=f,r[7]=c}),k.on("mouseout",function(t){e(this).css("cursor","default"),e(this).off("mousemove")}),k.on("mouseover",function(t){e(this).css("cursor","default"),e(this).off("mousemove")})}}(jQuery);